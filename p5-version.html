<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newsreader.json // live</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'IBM Plex Mono', monospace;
            background: #000;
            color: #00ff00;
            overflow: hidden;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
            padding: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
        .terminal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        .terminal-line {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        .terminal-dim {
            color: #006600;
        }
        .terminal-bright {
            color: #00ff00;
            font-weight: 600;
        }
        .component-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 15px;
            font-size: 11px;
            max-height: 120px;
            overflow: hidden;
        }
        .controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #00ff00;
            padding: 30px;
            text-align: center;
            z-index: 2000;
            min-width: 400px;
        }
        .controls.hidden {
            display: none;
        }
        .controls h1 {
            font-size: 36px;
            margin-bottom: 10px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        .controls p {
            margin-bottom: 20px;
            color: #00ff00;
            font-size: 12px;
        }
        button {
            font-family: 'IBM Plex Mono', monospace;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #00ff00;
            cursor: pointer;
            background: #000;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.1s;
            pointer-events: all;
        }
        button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div class="terminal-header">
            <span>newsreader.json // live coding session</span>
            <span id="status">IDLE</span>
        </div>
    </div>

    <div class="component-info" id="componentInfo" style="display: none;">
        <div id="infoText"></div>
    </div>

    <div class="controls" id="startScreen">
        <h1>newsreader.json</h1>
        <p>Live sonification & visualization</p>
        <button onclick="startExperience()">â–¶ INITIALIZE</button>
    </div>

    <script>
        let components = [];
        let currentIndex = 0;
        let isPlaying = false;
        let synth;
        let osc = [];
        let particles = [];
        let tempo = 400;

        // D Mixolydian scale
        const scale = [
            146.83, 164.81, 185.00, 196.00, 220.00, 246.94, 261.63,
            293.66, 329.63, 369.99, 392.00, 440.00, 493.88, 523.25,
            587.33, 659.25, 739.99, 783.99, 880.00, 987.77, 1046.50
        ];

        // Load data
        fetch('metrics.json')
            .then(r => r.json())
            .then(data => {
                components = data.components.filter(c => c.totalTplRefs > 0);
                console.log(`Loaded ${components.length} components`);
            });

        function startExperience() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('componentInfo').style.display = 'block';
            document.getElementById('status').textContent = 'RUNNING';
            isPlaying = true;
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // Setup p5.sound
            synth = new p5.PolySynth();
            synth.setADSR(0.05, 0.2, 0.4, 0.5);
        }

        function draw() {
            background(0);
            
            if (!isPlaying || components.length === 0) {
                return;
            }

            // Play component every tempo ms
            if (frameCount % Math.floor(tempo / 16.67) === 0) {
                playComponent();
            }

            // Draw particles
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                
                stroke(0, 255, 0, p.alpha);
                strokeWeight(2);
                noFill();
                
                // Draw expanding circle
                circle(p.x, p.y, p.size);
                
                // Update particle
                p.size += p.speed;
                p.alpha -= 2;
                
                if (p.alpha <= 0) {
                    particles.splice(i, 1);
                }
            }

            // Draw waveform visualization
            drawWaveform();
            
            // Draw scanlines (CRT effect)
            drawScanlines();
        }

        function playComponent() {
            if (currentIndex >= components.length) {
                currentIndex = 0;
            }

            const component = components[currentIndex];
            const counts = component.categoryRefCounts;

            // Map to frequencies
            const colorIndex = Math.min(Math.floor((counts.color / 90) * (scale.length - 1)), scale.length - 1);
            const rootFreq = scale[colorIndex];

            // Build chord
            let chord = [rootFreq];
            if (counts.spacing > 0) chord.push(rootFreq * 1.5); // Fifth
            if (counts.typography > 3) chord.push(rootFreq * 1.26); // Third
            if (counts.other > 8) chord.push(rootFreq * 2.0); // Octave

            // Play chord
            synth.play(rootFreq, 0.3, 0, 0.4);
            chord.forEach((freq, i) => {
                setTimeout(() => {
                    synth.play(freq, 0.2, 0, 0.3);
                }, i * 30); // Slight arpeggio
            });

            // Create visual particles based on data
            const numParticles = Math.min(counts.color + counts.typography + counts.spacing + counts.other, 20);
            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: random(width * 0.2, width * 0.8),
                    y: random(height * 0.2, height * 0.8),
                    size: 10,
                    speed: random(2, 8),
                    alpha: 255
                });
            }

            // Update terminal display
            updateTerminalInfo(component, chord);

            currentIndex++;
        }

        function drawWaveform() {
            push();
            stroke(0, 255, 0, 100);
            strokeWeight(1);
            noFill();
            
            beginShape();
            for (let i = 0; i < width; i += 10) {
                let y = height / 2 + sin(frameCount * 0.02 + i * 0.05) * 30;
                vertex(i, y);
            }
            endShape();
            pop();
        }

        function drawScanlines() {
            push();
            stroke(0, 255, 0, 10);
            strokeWeight(1);
            for (let y = 0; y < height; y += 4) {
                line(0, y, width, y);
            }
            pop();
        }

        function updateTerminalInfo(component, chord) {
            const counts = component.categoryRefCounts;
            const info = `
<span class="terminal-bright">// ${component.name}</span>
<span class="terminal-dim">${component.path}</span>

<span class="terminal-line">color: ${counts.color} | typo: ${counts.typography} | spacing: ${counts.spacing} | other: ${counts.other}</span>
<span class="terminal-line">chord: ${chord.length} notes | index: ${currentIndex}/${components.length}</span>
            `;
            document.getElementById('infoText').innerHTML = info.trim();
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function keyPressed() {
            // Press SPACE to toggle play/pause
            if (key === ' ') {
                isPlaying = !isPlaying;
                document.getElementById('status').textContent = isPlaying ? 'RUNNING' : 'PAUSED';
            }
            // Press R to restart
            if (key === 'r' || key === 'R') {
                currentIndex = 0;
            }
            // Arrow keys for tempo
            if (keyCode === UP_ARROW) {
                tempo = Math.max(50, tempo - 50);
            }
            if (keyCode === DOWN_ARROW) {
                tempo = Math.min(3000, tempo + 50);
            }
        }
    </script>
</body>
</html>

