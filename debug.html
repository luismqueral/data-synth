<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSynth Debug</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'IBM Plex Sans', sans-serif; }
        body { background: #fff; margin: 0; padding: 40px; max-width: 1200px; margin: 0 auto; }
        
        h1 { font-size: 32px; font-weight: 600; margin-bottom: 8px; }
        h2 { font-size: 18px; font-weight: 600; margin-top: 40px; margin-bottom: 16px; border-bottom: 2px solid #000; padding-bottom: 8px; }
        
        .summary { display: flex; gap: 20px; margin-bottom: 40px; }
        .stat { background: #000; color: #fff; padding: 20px; border-radius: 4px; flex: 1; }
        .stat-value { font-family: 'IBM Plex Mono', monospace; font-size: 36px; font-weight: 600; }
        .stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.7; margin-top: 4px; letter-spacing: 0.5px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #f5f5f5; font-weight: 600; border-bottom: 2px solid #ddd; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        
        .pass { color: #28a745; }
        .fail { color: #dc3545; }
        
        .system-info { background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 40px; font-size: 13px; }
        .system-info div { margin-bottom: 8px; }
        .system-info strong { display: inline-block; width: 120px; }
    </style>
</head>
<body>
    <h1>DataSynth Debug</h1>
    <p style="color: #666; margin-bottom: 32px;">Comprehensive test suite and diagnostics</p>
    
    <div class="summary">
        <div class="stat">
            <div class="stat-value" id="total">--</div>
            <div class="stat-label">Total Tests</div>
        </div>
        <div class="stat" style="background: #28a745;">
            <div class="stat-value" id="passed">--</div>
            <div class="stat-label">Passed</div>
        </div>
        <div class="stat" style="background: #dc3545;">
            <div class="stat-value" id="failed">--</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat" style="background: #007bff;">
            <div class="stat-value" id="rate">--</div>
            <div class="stat-label">Success Rate</div>
        </div>
    </div>
    
    <div class="system-info">
        <div><strong>Browser:</strong> <span id="browser">--</span></div>
        <div><strong>Screen:</strong> <span id="screen">--</span></div>
        <div><strong>DPR:</strong> <span id="dpr">--</span></div>
        <div><strong>Web Audio:</strong> <span id="audio">--</span></div>
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        // Error handling wrapper
        window.addEventListener('error', (e) => {
            document.getElementById('results').innerHTML = `
                <div style="background: #f8d7da; padding: 20px; border: 1px solid #dc3545; border-radius: 4px;">
                    <strong>JavaScript Error:</strong><br>
                    <code>${e.message}</code><br>
                    <small>${e.filename}:${e.lineno}</small>
                </div>
            `;
        });
        
        try {
            const { getValueByPath, safeId, extractPaths, extractValues, analyzeDataVariance } = await import('./lib/data-processor.js');
            const { AudioEngine } = await import('./lib/audio-engine.js');
            const { ParameterMapper } = await import('./lib/parameter-mapper.js');
            const { PatchViz } = await import('./lib/patch-viz.js');
        
        // System info
        document.getElementById('browser').textContent = navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown';
        document.getElementById('screen').textContent = `${window.screen.width} × ${window.screen.height}`;
        document.getElementById('dpr').textContent = `${window.devicePixelRatio}x`;
        document.getElementById('audio').textContent = 'AudioContext' in window ? '✅ Supported' : '❌ Not Supported';
        
        const allResults = [];
        
        function test(module, name, assertion) {
            const pass = typeof assertion === 'function' ? assertion() : assertion;
            allResults.push({ module, name, pass });
            return pass;
        }
        
        function renderTable(title, tests) {
            const passed = tests.filter(t => t.pass).length;
            const html = `
                <h2>${title} <span style="font-size: 14px; color: #666;">(${passed}/${tests.length})</span></h2>
                <table>
                    <thead><tr><th style="width: 60px;">Result</th><th>Test</th></tr></thead>
                    <tbody>
                        ${tests.map(t => `
                            <tr>
                                <td class="${t.pass ? 'pass' : 'fail'}">${t.pass ? '✓ Pass' : '✗ Fail'}</td>
                                <td>${t.name}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('results').innerHTML += html;
        }
        
        // ================================================================
        // DATA PROCESSOR TESTS
        // ================================================================
        
        // getValueByPath
        const testData = { properties: { mag: 4.5 }, user: { name: 'Luis' } };
        test('data-processor', 'getValueByPath - simple nested path', getValueByPath(testData, 'properties.mag') === 4.5);
        test('data-processor', 'getValueByPath - missing path returns undefined', getValueByPath(testData, 'missing') === undefined);
        test('data-processor', 'getValueByPath - handles null object', getValueByPath(null, 'path') === undefined);
        test('data-processor', 'getValueByPath - handles empty path', getValueByPath(testData, '') === undefined);
        test('data-processor', 'getValueByPath - deeply nested path', getValueByPath({ a: { b: { c: 42 } } }, 'a.b.c') === 42);
        
        // safeId
        test('data-processor', 'safeId - converts dots to underscores', safeId('properties.mag') === 'properties_mag');
        test('data-processor', 'safeId - handles complex paths', safeId('geo.coords.0') === 'geo_coords_0');
        test('data-processor', 'safeId - removes special characters', safeId('user-name@domain').includes('user') && safeId('user-name@domain').includes('name'));
        
        // extractPaths
        const simpleObj = { name: 'Test', value: 42, active: true };
        const paths1 = extractPaths(simpleObj);
        test('data-processor', 'extractPaths - simple object with 3 fields', paths1.length === 3);
        test('data-processor', 'extractPaths - detects types', paths1.some(p => p.type === 'number'));
        
        const nested = { user: { name: 'Luis', age: 30 } };
        const paths2 = extractPaths(nested);
        test('data-processor', 'extractPaths - nested paths', paths2.some(p => p.path === 'user.name'));
        
        const arrayData = [{ properties: { mag: 4.5 } }, { properties: { mag: 3.2 } }];
        const paths3 = extractPaths(arrayData);
        test('data-processor', 'extractPaths - array of objects', paths3.length > 0);
        test('data-processor', 'extractPaths - calculates coverage', paths3[0]?.coverage === 1.0);
        
        // extractValues
        const values1 = extractValues(arrayData, 'properties.mag');
        test('data-processor', 'extractValues - extracts from array', values1.length === 2 && values1[0] === 4.5);
        test('data-processor', 'extractValues - filters undefined', () => {
            const v = extractValues([{ mag: 1 }, { other: 2 }], 'mag');
            return v.length === 1;
        });
        
        // analyzeDataVariance
        const norm = analyzeDataVariance([10, 20, 30, 40, 50]);
        test('data-processor', 'analyzeDataVariance - linear for normal', norm.suggestedCurve === 'linear');
        
        const tiny = analyzeDataVariance([99.1, 99.2, 99.3]);
        test('data-processor', 'analyzeDataVariance - cubic for tiny variance', tiny.suggestedCurve === 'cubic');
        
        test('data-processor', 'analyzeDataVariance - handles empty array', () => {
            const result = analyzeDataVariance([]);
            return result.suggestedCurve === 'linear';
        });
        
        // ================================================================
        // PARAMETER MAPPER TESTS
        // ================================================================
        
        const mapper = new ParameterMapper();
        test('parameter-mapper', 'ParameterMapper - constructor', mapper !== null);
        
        mapper.initializeMappings();
        test('parameter-mapper', 'initializeMappings - creates mappings', Object.keys(mapper.mappings).length > 0);
        
        const synthParams = mapper.getAudioParams();
        test('parameter-mapper', 'getAudioParams - returns array', Array.isArray(synthParams));
        test('parameter-mapper', 'getAudioParams - includes frequency', synthParams.some(p => p.id === 'frequency'));
        test('parameter-mapper', 'getAudioParams - includes pan', synthParams.some(p => p.id === 'pan'));
        
        mapper.samplerMode = true;
        const samplerParams = mapper.getAudioParams();
        test('parameter-mapper', 'getAudioParams - sampler has pitch', samplerParams.some(p => p.id === 'pitch'));
        test('parameter-mapper', 'getAudioParams - sampler has sampleOffset', samplerParams.some(p => p.id === 'sampleOffset'));
        
        mapper.samplerMode = false;
        
        // intelligentMapping needs properly formatted paths with variance data
        const testPaths = [
            { path: 'value1', type: 'number', variance: 30, min: 0, max: 100, uniqueRatio: 0.5 },
            { path: 'value2', type: 'number', variance: 50, min: 0, max: 100, uniqueRatio: 0.8 },
            { path: 'value3', type: 'number', variance: 20, min: 0, max: 50, uniqueRatio: 0.6 }
        ];
        
        try {
            mapper.intelligentMapping(testPaths);
            test('parameter-mapper', 'intelligentMapping - creates mappings', Object.values(mapper.mappings).some(m => m && m.path));
            test('parameter-mapper', 'intelligentMapping - maps critical params', mapper.mappings.frequency?.path !== undefined);
            
            const origPath = mapper.mappings.frequency?.path;
            mapper.randomizeMappings(testPaths);
            test('parameter-mapper', 'randomizeMappings - changes paths', mapper.mappings.frequency?.path !== origPath);
        } catch (e) {
            console.error('intelligentMapping error:', e);
            test('parameter-mapper', 'intelligentMapping - creates mappings', false);
            test('parameter-mapper', 'intelligentMapping - maps critical params', false);
            test('parameter-mapper', 'randomizeMappings - changes paths', false);
        }
        
        const origMin = mapper.mappings.frequency?.min;
        mapper.randomizeRanges();
        test('parameter-mapper', 'randomizeRanges - changes ranges', mapper.mappings.frequency?.min !== origMin);
        
        // ================================================================
        // AUDIO ENGINE TESTS  
        // ================================================================
        
        const engine = new AudioEngine();
        test('audio-engine', 'Constructor creates instance', engine !== null);
        test('audio-engine', 'AudioContext null before init', engine.audioContext === null);
        
        engine.initEffects();
        test('audio-engine', 'initEffects creates AudioContext', engine.audioContext !== null);
        test('audio-engine', 'Delay node created', engine.delayNode !== null);
        test('audio-engine', 'Reverb node created', engine.reverbNode !== null);
        test('audio-engine', 'Reverb wet gain created', engine.reverbWetGain !== null);
        test('audio-engine', 'Reverb dry gain created', engine.reverbDryGain !== null);
        
        // Reverb impulse
        const impulse = engine.createReverbImpulse(2, 2);
        test('audio-engine', 'createReverbImpulse returns AudioBuffer', impulse instanceof AudioBuffer);
        test('audio-engine', 'Reverb impulse has correct duration', Math.abs(impulse.duration - 2) < 0.1);
        test('audio-engine', 'Reverb impulse has channels', impulse.numberOfChannels > 0);
        
        // Noise buffers
        const white = engine.createNoiseBuffer('white', 1);
        test('audio-engine', 'White noise buffer created', white instanceof AudioBuffer);
        test('audio-engine', 'White noise has correct duration', white.duration === 1);
        
        const pink = engine.createNoiseBuffer('pink', 1);
        test('audio-engine', 'Pink noise buffer created', pink instanceof AudioBuffer);
        
        const brown = engine.createNoiseBuffer('brown', 1);
        test('audio-engine', 'Brown noise buffer created', brown instanceof AudioBuffer);
        
        // Oscillator
        const osc = engine.createCustomOscillator(440, 'sine', 1000);
        test('audio-engine', 'createCustomOscillator - sine wave', osc !== null && osc.oscillator);
        test('audio-engine', 'Oscillator frequency set', osc.oscillator.frequency.value === 440);
        test('audio-engine', 'Oscillator type set', osc.oscillator.type === 'sine');
        
        const fm = engine.createCustomOscillator(440, 'fm', 1000);
        test('audio-engine', 'FM synthesis creates oscillators', fm !== null && fm.oscillator);
        
        const additive = engine.createCustomOscillator(440, 'additive', 1000);
        test('audio-engine', 'Additive synthesis creates oscillators', additive !== null && additive.oscillators);
        test('audio-engine', 'Additive has multiple oscillators', additive.oscillators.length > 1);
        
        // Visualizer
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 160;
        document.body.appendChild(canvas);
        canvas.style.display = 'none';
        
        engine.setupVisualizer(canvas);
        test('audio-engine', 'setupVisualizer creates analyser', engine.analyser !== null);
        test('audio-engine', 'Stereo splitter created', engine.splitter !== null);
        test('audio-engine', 'Right analyser created', engine.analyserRight !== null);
        test('audio-engine', 'fftSize configured (1024)', engine.analyser.fftSize === 1024);
        test('audio-engine', 'Smoothing configured (0.3)', engine.analyser.smoothingTimeConstant === 0.3);
        test('audio-engine', 'dataArray created', engine.dataArray instanceof Uint8Array);
        test('audio-engine', 'dataArrayRight created', engine.dataArrayRight instanceof Uint8Array);
        test('audio-engine', 'Canvas context stored', engine.visualizerCtx !== null);
        
        document.body.removeChild(canvas);
        
        // ================================================================
        // PATCH VIZ TESTS
        // ================================================================
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.id = 'testSVG';
        svg.style.display = 'none';
        document.body.appendChild(svg);
        
        const viz = new PatchViz('testSVG');
        test('patch-viz', 'Constructor creates instance', viz !== null);
        test('patch-viz', 'SVG element found', viz.svg !== null);
        test('patch-viz', 'Nodes array initialized', Array.isArray(viz.nodes));
        
        const vizPaths = [{ path: 'test.val', type: 'number' }];
        const vizMapper = new ParameterMapper();
        vizMapper.initializeMappings();
        
        try {
            viz.render(vizPaths, vizMapper.mappings, vizMapper, false);
            test('patch-viz', 'render executes without error', true);
            test('patch-viz', 'Nodes created after render', viz.nodes.length > 0);
        } catch (e) {
            test('patch-viz', 'render executes without error', false);
            test('patch-viz', 'Nodes created after render', false);
        }
        
        document.body.removeChild(svg);
        
        // ================================================================
        // RENDER RESULTS
        // ================================================================
        
        const modules = {};
        allResults.forEach(t => {
            if (!modules[t.module]) modules[t.module] = [];
            modules[t.module].push(t);
        });
        
        const total = allResults.length;
        const passed = allResults.filter(t => t.pass).length;
        const failed = total - passed;
        
        document.getElementById('total').textContent = total;
        document.getElementById('passed').textContent = passed;
        document.getElementById('failed').textContent = failed;
        document.getElementById('rate').textContent = ((passed / total) * 100).toFixed(1) + '%';
        
        Object.keys(modules).sort().forEach(mod => {
            renderTable(mod.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' '), modules[mod]);
        });
        
        console.log(`✅ ${passed}/${total} tests passed`);
        
        } catch (error) {
            console.error('Error running tests:', error);
            document.getElementById('results').innerHTML = `
                <div style="background: #f8d7da; padding: 20px; border: 1px solid #dc3545; border-radius: 4px; font-family: monospace;">
                    <strong>Error loading modules:</strong><br>
                    ${error.message}<br>
                    <small>${error.stack}</small>
                </div>
            `;
        }
    </script>
</body>
</html>
